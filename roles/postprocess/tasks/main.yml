#
# Copyright 2019-2020 Martin Goellnitz.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

- name: Install MySQL Client
  package: name=mysql-client-5.7 update_cache=yes

#- name: DB Wipe Script
#  template:
#    src: wipe-db.sh
#    dest: /opt/coremedia
#    owner: ubuntu
#    group: ubuntu
#    mode: '0755'

- name: Ensure remote Backup Directory
  file:
    path: /var/coremedia/backup
    owner: ubuntu
    group: ubuntu
    state: directory
    mode: '0755'

#- name: Push MLS Backup
#  copy:
#    dest: /var/coremedia/backup/cm_master.sql
#    src: "{{ backup_dir }}/cm_master.sql"

- name: MLS Restore Script
  template: 
    src: restore-from-mls.sh
    dest: /opt/coremedia
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Select Script
  template:
    src: select.sql
    dest: /opt/coremedia
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Insert Script Template
  template:
    src: insert.sql
    dest: /opt/coremedia
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Prepare DB Restore Script
  template:
    src: prepare-db.sh
    dest: /opt/coremedia
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Stop Replication Live Server
  service:
    name: replication-live-server
    state: stopped
    
#- name: Wipe Database 1/5
#  shell: "/opt/coremedia/wipe-db.sh repl"

#- name: Wipe Database 2/5
#  shell: "/opt/coremedia/wipe-db.sh repl"

#- name: Wipe Database 3/5
#  shell: "/opt/coremedia/wipe-db.sh repl"

#- name: Wipe Database 4/5
#  shell: "/opt/coremedia/wipe-db.sh repl"

#- name: Wipe Database 5/5
#  shell: "/opt/coremedia/wipe-db.sh repl"

- name: MLS Restore
  shell: "/opt/coremedia/restore-from-mls.sh repl"

- name: Start Replication Live Server
  service:
    name: replication-live-server
    state: started

- name: Reset Live CAEFeeder
  shell: "cd /opt/coremedia/caefeeder-live-tools ; bin/cm resetcaefeeder reset"

- name: Re-Start CAEFeeder Live
  service:
    name: caefeeder-live
    state: restarted
